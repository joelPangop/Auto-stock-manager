<div class="header">
  <button mat-stroked-button color="primary" routerLink="/voitures">
    <mat-icon>arrow_back</mat-icon>&nbsp;Retour
  </button>
  <span class="spacer"></span>

  <!-- Boutons selon le mode -->
  <ng-container *ngIf="v$ | async as v">
    <button *ngIf="!isEditing && isOwner" mat-flat-button color="primary" (click)="edit()">
      <mat-icon>edit</mat-icon>&nbsp;Modifier
    </button>
    <ng-container *ngIf="isEditing">
      <button mat-stroked-button color="primary" (click)="cancel()" *ngIf="isOwner">
        <mat-icon>close</mat-icon>&nbsp;Annuler
      </button>
      <button mat-flat-button color="primary" (click)="save(v.id)" [disabled]="form.invalid" *ngIf="isOwner">
        <mat-icon>save</mat-icon>&nbsp;Enregistrer
      </button>
    </ng-container>

    <button mat-stroked-button color="primary"  *ngIf="isOwner" (click)="nouvelleVente()">
      <mat-icon>sell</mat-icon>&nbsp;Nouvelle vente
    </button>
  </ng-container>
</div>

<mat-card class="card" *ngIf="v$ | async as v">
  <div class="key-info" *ngIf="!isEditing; else editHeader">
    <div class="title">{{ marqueLabelle }} {{ modeleLabelle }} ({{ v.annee }})</div>
    <div class="sub">VIN: {{ v.vin || '—' }} • Couleur: {{ v.couleur || '—' }} • Km: {{ v.kilometrage || '—' }}</div>
    <div class="price">{{ v.prixVente | number:'1.0-0' }} $</div>
    <div class="status">
      <span class="chip" [class.success]="v.statut==='EN_STOCK'" [class.warn]="v.statut==='VENDUE'">
        {{ v.statut || v.statut }}
      </span>
    </div>
  </div>

  <ng-template #editHeader>
    <form [formGroup]="form" class="header-form">
      <div class="row-inline">
        <mat-form-field appearance="outline" class="grow">
          <mat-label>Marque</mat-label>
          <mat-select formControlName="idMarque">
            <mat-option *ngFor="let m of marques" [value]="m.id">{{ m.nom }}</mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('idMarque')?.hasError('required')">Obligatoire</mat-error>
        </mat-form-field>
      </div>

      <div class="row-inline">
        <mat-form-field appearance="outline" class="grow">
          <mat-label>Modèle</mat-label>
          <mat-select formControlName="idModele" [disabled]="!form.value.idMarque">
            <mat-option *ngFor="let mo of modeles" [value]="mo.id">{{ mo.nom }}</mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('idModele')?.hasError('required')">Obligatoire</mat-error>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Année</mat-label>
        <input matInput type="number" formControlName="annee">
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Prix d'achat</mat-label>
        <input matInput type="number" formControlName="prixAchat">
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Prix de vente</mat-label>
        <input matInput type="number" formControlName="prixVente">
      </mat-form-field>
    </form>
  </ng-template>

  <mat-tab-group>
    <!-- Onglet Détails -->
    <mat-tab label="Détails">
      <div class="tab-pad">
        <ng-container *ngIf="!isEditing; else editDetails">
          <div class="details-grid">
            <div><strong>Marque</strong>
              <div>{{ marqueLabelle }}</div>
            </div>
            <div><strong>Modèle</strong>
              <div>{{ modeleLabelle }}</div>
            </div>
            <div><strong>Année</strong>
              <div>{{ v.annee }}</div>
            </div>
            <div><strong>Statut</strong>
              <div>{{ v.statut }}</div>
            </div>
            <div><strong>Prix de Achat</strong>
              <div>{{ v.prixAchat | number:'1.0-0' }} $</div>
            </div>
            <div><strong>Prix de vente</strong>
              <div>{{ v.prixVente | number:'1.0-0' }} $</div>
            </div>
            <div><strong>VIN</strong>
              <div>{{ v.vin || '—' }}</div>
            </div>
            <div><strong>Couleur</strong>
              <div>{{ v.couleur || '—' }}</div>
            </div>
            <div><strong>Kilométrage</strong>
              <div>{{ v.kilometrage || '—' }}</div>
            </div>
            <div><strong>Fournisseur</strong>
              <div>{{ fournisseurLibelle || '—' }}</div>
            </div>
            <div><strong>Créée le</strong>
              <div>{{ v.createdAt | date:'short' }}</div>
            </div>
            <div><strong>Modifiée le</strong>
              <div>{{ v.updatedAt | date:'short' }}</div>
            </div>
          </div>
        </ng-container>

        <ng-template #editDetails>
          <form [formGroup]="form" class="edit-grid">
            <mat-form-field appearance="outline">
              <mat-label>VIN</mat-label>
              <input matInput formControlName="vin">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Couleur</mat-label>
              <input matInput formControlName="couleur">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Kilométrage</mat-label>
              <input matInput type="number" formControlName="kilometrage">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Statut</mat-label>
              <mat-select formControlName="statut">
                <mat-option value="DISPONIBLE">DISPONIBLE</mat-option>
                <mat-option value="RESERVEE">RESERVEE</mat-option>
                <mat-option value="EN_STOCK">EN_STOCK</mat-option>
                <mat-option value="VENDUE">VENDUE</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fournisseur</mat-label>
              <mat-select formControlName="idFournisseur">
                <mat-option [value]="null">— Aucun —</mat-option>
                <mat-option *ngFor="let f of fournisseurs" [value]="f.id">
                  {{ f.nom }} <span *ngIf="f.type">({{ f.type }})</span>
                </mat-option>
              </mat-select>
            </mat-form-field>

          </form>
        </ng-template>
      </div>
    </mat-tab>

    <!-- DOCUMENTS -->
    <mat-tab label="Documents">
      <div class="tab-pad docs-tab">
        <div class="row">
          <button mat-stroked-button (click)="openUploadDialog()" *ngIf="isOwner">
            <mat-icon>upload_file</mat-icon>&nbsp;Ajouter
          </button>
        </div>

        <table class="docs" *ngIf="documents$ | async as docs; else loadingDocs">
          <thead>
          <tr>
            <th style="width:36px;"></th>
            <th>Type</th>
            <th>Description</th>
            <th>Fichier</th>
            <th>Date</th>
            <th class="r">Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let d of docs">
            <td><mat-icon>description</mat-icon></td>
            <td>{{ d.type }}</td>
            <td>{{ d.description || '—' }}</td>
            <td>{{ d.nomFichier }}</td>
            <td>{{ d.dateUpload | date:'short' }}</td>
            <td class="r">
              <button mat-icon-button (click)="download(d)"><mat-icon>download</mat-icon></button>
              <button mat-icon-button color="primary" (click)="openEditDocDialog(d)" *ngIf="isOwner"><mat-icon>edit</mat-icon></button>
              <button mat-icon-button color="warn" (click)="deleteDoc(d)" *ngIf="isOwner"><mat-icon>delete</mat-icon></button>
            </td>
          </tr>
          </tbody>
        </table>

        <ng-template #loadingDocs>
          <div class="muted">Chargement des documents…</div>
        </ng-template>
      </div>
    </mat-tab>


    <!-- ENTRETIENS -->
    <mat-tab label="Entretiens">
      <div class="tab-pad">
        <button mat-stroked-button (click)="planifierEntretien()" *ngIf="isOwner">
          <mat-icon>build</mat-icon>&nbsp;Planifier
        </button>

        <mat-list *ngIf="entretiens$ | async as entretiens; else entLoading">
          <mat-list-item *ngFor="let e of entretiens">
            <mat-icon matListItemIcon>build</mat-icon>
            <div matListItemTitle>{{ e.typeLabel }} — {{ e.dateEntretien | date }}</div>
            <div matListItemLine> {{ ' — '+e.commentaire || '—' }}</div>
            <div class="right">{{ e.cout | number:'1.0-0' }} $</div>
          </mat-list-item>
          <mat-divider></mat-divider>
          <mat-list-item>
            <div><p>Total Cout:  </p> </div>
            <div>{{totalCoutEntretien}} $</div>
          </mat-list-item>
          <div *ngIf="entretiens.length === 0" class="muted">Aucun entretien.</div>
        </mat-list>
        <ng-template #entLoading>
          <div class="muted">Chargement…</div>
        </ng-template>
      </div>
    </mat-tab>

    <!-- MOUVEMENTS -->
    <mat-tab label="Mouvements">
      <div class="tab-pad">
        <button mat-stroked-button (click)="nouveauMouvement()" *ngIf="isOwner">
          <mat-icon>compare_arrows</mat-icon>&nbsp;Ajouter
        </button>

        <table class="docs" *ngIf="mouvements$ | async as mouvements; else movLoading">
          <tr *ngFor="let m of mouvements">
            <td>{{ m.type }}</td>
            <td>{{ m.dateMouvement | date:'short' }}</td>
            <td>{{ m.commentaire || '—' }}</td>
          </tr>
          <tr *ngIf="mouvements.length === 0">
            <td colspan="3" class="muted">Aucun mouvement.</td>
          </tr>
        </table>
        <ng-template #movLoading>
          <div class="muted">Chargement…</div>
        </ng-template>
      </div>
    </mat-tab>
  </mat-tab-group>
</mat-card>
